<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <title> new document </title>
  <meta name="generator" content="editplus">
  <meta name="author" content="">
  <meta name="keywords" content="">
  <meta name="description" content="">
<script type="text/javascript" src="js/base64.js"></script>
<script type="text/javascript" id="game_source">
/**
@class Note
@param _uid
@since 2014-05-17
*/
function Note(_uid) {
 /***/
 this.uid = _uid;
 /***/
 this.text = null;
 /***/
 this.title = null;
 /***/
 this.connections = [];
 /***/
 this.load = function(data) {
  this.uid = data['uid'];
  this.text = data['text'];
  this.title = data['title'];
  for (var i = 0; i < data['connections'].length;i++) {
   var connection = new Note(data['connections'][i]['uid']);
   connection.load(data['connections'][i]);
   game.notes.push(connection);
  }
 };
};
/**
@class Connection
@param _uid
@since 2014-05-17
*/
function Connection(_uid) {
 /***/
 this.uid = _uid;
 /***/
 this.text = null;
 /***/
 this.to_uid = null;
 /***/
 this.load = function(data) {
  this.uid = data['uid'];
  this.text = data['text'];
  this.to_uid = data['to_uid'];
 };
};
/**
@class MediaLanguage
@param _lan
@since 2014-05-18
*/
function MediaLanguage(_lan) {
 this.language = _lan;
 this.medias = [];
 this.setMedia = function(_k, _v) {
  if (this.hasMedia(_k)) {
   this.getMedia(_k).value = Base64.encode(_v);
  } else {
   this.addMedia(_k, _v);
  }
 }
 this.getMedia = function(_k) {
  for (var i = 0; i < this.medias.length; i++) {
   if (this.medias[i].key == _k) {
    return this.medias[i];
   }
  }
  return null;
 }
 this.getMediaValue = function(_k) {
  for (var i = 0; i < this.medias.length; i++) {
   if (this.medias[i].key == _k) {
    return Base64.decode(this.medias[i].value);
   }
  }
  return null;
 }
 this.hasMedia = function(_k, _v) {
  for (var i = 0; i < this.medias.length; i++) {
   if (this.medias[i].key == _k) {
    return true;
   }
  }
  return false;
 }
 this.deleteMedia = function(_k, _v) {
  for (var i = 0; i < this.medias.length; i++) {
   if (this.medias[i].key == _k) {
    return this.medias.splice(i, 1);
   }
  }
 }
 this.addMedia = function(_k, _v) {
  this.medias.push(this.createMedia(_k, _v));
 }
 this.createMedia = function(_k, _v) {
  return { key : _k, value : Base64.encode(_v) };
 }
}
/**
The main singleton
@class game
@since 2014-05-17
*/
var game = {
 /**
 the major data type array
 @parameter notes 
 @since 2014-05-17
 */
 notes : [],
 /**
 @method load
 @since 2014-05-17
 */
 load : function() {
  var data = window.localStorage.getItem('game_data');
  data = JSON.parse(data);
  if (data == null) {
   //avoid a cannot read property exception
   console.log(data);
   return;
  }
  for (var i = 0; i < data['notes'].length;i++) {
   var note = new Note(data['notes'][i]['uid']);
   note.load(data['notes'][i]);
   this.notes.push(note);
  }
 },
 /**
 @method save
 @since 2014-05-17
 */
 save : function() {
  var data = JSON.stringify(game);
  console.log('save data:');
  console.log(data);
  console.log(':save data');
  window.localStorage.setItem('game_data', data);
 },
 /**
 @class mediamanager
 @since 2014-05-18
 */
 mediamanager : {
  defaultLanguage : 'en',
  currentLanguage : 'en',
  languages : [],
  mediaLanguages : [],
  setCurrentLanguage : function(_lan) {
   this.currentLanguage = _lan;
   if (!this.hasLanguage(_lan)) {
    this.addLanguage(_lan);    
   }
  },
  addLanguage : function(_lan) {
   this.mediaLanguages.push( new MediaLanguage(_lan) );
   this.languages.push(_lan);
  },
  hasLanguage : function(_lan) {
   for (var i = 0; i < this.languages.length; i++) {
    if (this.languages[i] == _lan) {
     return true;
    }  
   }
   return false;
  },
  getCurrentLanguage : function() {
   for (var i = 0; i < this.mediaLanguages.length; i++) {
    if (this.mediaLanguages[i].language == this.currentLanguage) {
     return this.mediaLanguages[i];
    }  
   }
   this.currentLanguage = this.defaultLanguage;
   var language = new MediaLanguage(this.currentLanguage);
   this.mediaLanguages.push( language );
   this.languages.push(this.currentLanguage);
   return language;
  },
  setMedia : function(_k, _v) {
   //type64=true|false would regulate de/encoding or not 
   for (var i = 0; i < this.mediaLanguages.length; i++) {
    this.mediaLanguages[i].setMedia(_k, _v);
   }
  },
  deleteMedia : function(_k) {
   for (var i = 0; i < this.mediaLanguages.length; i++) {
    this.mediaLanguages[i].deleteMedia(_k);
   }
  },
  getMedia : function(_k) {
   this.getCurrentLanguage().getMedia(_k);
  },
  getMediaValue : function(_k) {
   this.getCurrentLanguage().getMediaValue(_k);
  }
 }
};

</script>
 <script type="text/javascript">

  (
    function(_win) {
      var editor = {};
      /***/
      editor.func = null;
      /***/
      editor.width = 0;
      /***/
      editor.height = 0;
      /***/
      editor.game = game;
      /***/
      editor.saveCode = function() {
        var code = getElement('texteditor').value;
        _win.localStorage.setItem('texteditor-code', code);
      };
      /***/
      editor.loadCode = function() {
        var code = _win.localStorage.getItem('texteditor-code');
        getElement('texteditor').value = code;
      };
      /***/
      editor.testCode = function() {
        var code = _win.localStorage.getItem('texteditor-code');
        //getElement('texteditor').value = code;
        //perform the code
        try {
          editor.func = new Function('window,document', code);
          editor.func(window, document);
        } catch(e) {
          console.log(e);
        }
      };
      /***/
      editor.stopTest = function() {
        if (editor.func != null) {
          editor.func = null;
          document.body.removeChild(document.body.childNodes[document.body.childNodes.length-1]);
        }
      };
      /***/
      editor.toggleEditor = function() {
        if (getElement('noteeditor').style.display != 'none') {
          getElement('noteeditor').style.display = 'none';
          getElement('texteditor').style.display = 'block';
        } else {
          getElement('noteeditor').style.display = 'block';
          getElement('texteditor').style.display = 'none';
        }
      };
      /***/
      editor.resize = function() {
        editor.width = window.innerWidth;
        editor.height = window.innerHeight;
        var ele = getElement('editor');
        ele.style.height = (editor.height - 5) + 'px';
        ele.style.width = (editor.width - 5) + 'px';
        var game_source = getElement('game_source').innerHTML;
        getElement('texteditor').value = getElement('texteditor').value + game_source;
        editor.game = game;
        ele = getElement('noteeditor').addEventListener('mousedown', editor.mousedown, false);
        //experimental from here
        
      };
      editor.uidcounter = [];
      /**
      @method createUid
      @since 2014-05-18
      */
      editor.createUid = function() {
        var abc = 'abcdefghijklmnopqrstuvwxyz1234567890ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        var uid = '';
        while (uid.length < 5 || editor.hasUid(uid)) {
          for (var i = 0; i < 5; i++) {
            uid = uid + abc.substr(Math.floor(Math.random()*abc.length), 1);
          }
          if (editor.hasUid(uid)) {
            uid = '';
          }
        }
        editor.uidcounter.push(uid);
        return uid;
      }
      /**
      @method hasUid
      @since 2014-05-18
      @param _uid
      */
      editor.hasUid = function(_uid) {
        for (var i = 0; i < editor.uidcounter.length; i++) {
          if (editor.uidcounter[i] == _uid) {
            return true;
          }
        }
        return false;
      }
      /**
      @method deleteUid
      @since 2014-05-18
      */
      editor.deleteUid = function(_uid) {
        for (var i = 0; i < editor.uidcounter.length; i++) {
          if (editor.uidcounter[i] == _uid) {
            editor.uidcounter.splice(i, 1);
          }
        }
      }
      editor.noteStartX = 5;
      editor.noteStartY = 5;
      /**
      @method addNote
      @since 2014-05-18
      */
      editor.addNote = function() {
        var note = new Note(editor.createUid());
        editor.game.notes.push(note);
        //add the visual note container to the noteeditor
        var ele = getElement('noteeditor');
        var child = createElement('div');
        child.className = 'note';
        child.setAttribute('id','note_'+note.uid);
        ele.appendChild(child);
        editor.noteStartX += 160;
        editor.noteStartY += 110;
        if (editor.noteStartX + 150 > editor.width) {
          editor.noteStartX = editor.noteStartX + 150 - editor.width;
        }
        if (editor.noteStartY + 110 > editor.height) {
          editor.noteStartY = editor.noteStartY + 110 - editor.height;
        }
        child.style.left = editor.noteStartX+'px';
        child.style.top = editor.noteStartY+'px';
        var child2 = createElement('div');
        child2.setAttribute('id','note_'+note.uid+'_bar');
        child2.className = 'note_bar';
        child.appendChild(child2);
        var child3 = createElement('span');
        child3.setAttribute('id','note_'+note.uid+'_uid');
        child3.className ='note_uid';
        child3.appendChild(document.createTextNode(note.uid));
        child2.appendChild(child3);
        child2 = createElement('input');
        child2.setAttribute('type','text'); 
        child2.setAttribute('id','note_'+note.uid+'_title');
        child2.className ='note_title';
        child2.setAttribute('placeholder','note title');
        child.appendChild(child2);        
        child2 = createElement('textarea');
        child2.setAttribute('id','note_'+note.uid+'_text');
        child2.className = 'note_text';
        child2.setAttribute('placeholder','note text');
        child.appendChild(child2);
      }
      /**
      @method deleteNote
      @since 2014-05-18
      */
      editor.deleteNote = function(_uid) {
        for (var i = 0; i < editor.game.notes.length; i++) {
          if (editor.game.notes[i].uid == _uid) {
            editor.game.notes.splice(i, 1);
            //delete the uid from the uid couter
            //delete the links' uids
            //delete the medias from the mediamanager
          }
        }
      }
      /***/
      editor.pressed = false;
      /***/
      editor.ox = 0;
      /***/
      editor.oy = 0;
      /**
      attach to 'noteeditor' element
      if uid begins with note it is a note
      no loop is needed
      @method mousedown
      @param eve
      @since 2014-05-18
      */
      editor.mousedown = function(eve) {
        if (!editor.pressed) {    
          var ele = eve.target;
          var splits = ele.id.split('_');
          var uid = splits[0]+'_'+splits[1];
          ele = getElement(uid);
          if (ele == null) {
            //do not know, what todo here right now
          } else {
            ele.addEventListener('mousemove', editor.mousemove, false);
            ele.addEventListener('mouseup', editor.mouseup, false);
            ele.addEventListener('mouseout', editor.mouseout, false);
            editor.ox = eve.pageX;
            editor.oy = eve.pageY;
            console.log(ele.id+':'+eve.pageX+','+eve.pageY);
            editor.pressed = true;
          }
        }
      }
      /**
      @method mousemove
      @param eve
      @since 2014-05-18
      */
      editor.mousemove = function(eve) {
        if (editor.pressed) {
          var ele = eve.target;
          var splits = ele.id.split('_');
          var uid = splits[0]+'_'+splits[1];
          ele = getElement(uid);
          var x = ele.offsetLeft + eve.pageX - editor.ox;
          var y = ele.offsetTop + eve.pageY - editor.oy;
          ele.style.top = y + 'px';
          ele.style.left = x + 'px';
          //console.log(ele.id+':'+eve.pageX+','+eve.pageY+','+ele.offsetLeft+','+ele.offsetTop);
          editor.ox = eve.pageX;
          editor.oy = eve.pageY;
        }
      }
      /**
      @method mouseup
      @param eve
      @since 2014-05-18
      */
      editor.mouseup = function(eve) {
        if (editor.pressed) {
          editor.pressed = false;
          //remove mouse listeners here?
        }
      }
      /**
      @method mouseout
      @param eve
      @since 2014-05-18
      */
      editor.mouseout = function(eve) {
        if (editor.pressed) {
          editor.pressed = false;
          //remove mouse listeners here?
        }
      }
      /***/
      _win.createElement = function(_ele) {
        return document.createElement(_ele);
      };
      /***/
      _win.getElement = function(_id) {
        return document.getElementById(_id);
      };
      /***/
      _win.editor = editor;
      _win.onload = function() { editor.resize(); };
    }

  )(window);

 </script>
 <style type="text/css">
body {margin: 0; padding: 0;}
.note{position: absolute; top: 5px; left: 5px; width: 150px; height: 100px; background: #ccc; box-shadow: -1px -1px 2px rgba(100,100,100,0.5), -1px 1px 2px rgba(100,100,100,0.5), 1px -1px 2px rgba(100,100,100,0.5), 3px 3px 6px rgba(100,100,100,0.5); }
.note_bar {margin: 1px; background: #009; width: 148px; height: 15px; color: white;}
.note_uid {font-size: 12px; font-family: sans-serif;}
.note_title {width: 145px; height: 15px; padding: 2px; border: 0; background: transparent}
.note_text {width: 145px; height: 60px; padding: 2px; border: 0; background: transparent; resize: none;}
 </style>
 </head>
 <body>
 <div id="editor" style="position: absolute; top: 0; left: 0; margin: 0; padding: 0;">
  <div id="editorbar" style="position: absolute; top: 0; left: 0; width: 100%; height: 10%; max-height: 10%;">
  <button onclick="editor.saveCode();" style="float: left;">save code</button>
  <button onclick="editor.loadCode();" style="float: left;">load code</button>
  <button onclick="editor.testCode();" style="float: left;">test code</button>
  <button onclick="editor.stopTest();" style="float: left;">stop test</button>
  <button onclick="editor.toggleEditor();" style="float: left;">toggle</button>
  <button onclick="editor.addNote();" style="float: left;">add note</button>
  <br style="clear: both;">
  </div>
  <textarea id="texteditor" style="position: absolute; top: 9%; left: 0; width: 80%; min-height: 90%; height: 90%; max-height: 90%;">var game_cvs = createElement('canvas');
game_cvs.style.width = '450px';
game_cvs.style.height = '300px';
game_cvs.style.background = '#000';
game_cvs.style.position = 'absolute';
game_cvs.style.top = '50px';
game_cvs.style.left = '0px';
document.body.appendChild(game_cvs);
  </textarea>
  <div id="noteeditor" style="position: absolute; top: 9%; left: 0; width: 100%; height: 90%; display: none; background: #eee; resize: none;">    
    <!--div id="note_" class="note">
    <div id="note_bar" class="note_bar"><span id="note_uid" class="note_uid">n0UID</span></div>
    <input type="text" id="note_title" class="note_title" placeholder="note title" /><textarea id="note_text" class="note_text" placeholder="note text"></textarea>
    </div-->
  </div>
 </div>
 </body>
</html>
